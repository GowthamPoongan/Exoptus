// Prisma schema for EXOPTUS authentication system
// Supports both SQLite (dev) and PostgreSQL (production)
// Change the provider below to switch databases

generator client {
  provider = "prisma-client-js"
}

// For SQLite (simple local development - no setup):
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// For PostgreSQL (production or if you prefer):
// datasource db {
//   provider = "postgresql"
//   url      = env("DATABASE_URL")
// }

// ============================================
// USERS TABLE - Core Identity
// ============================================
// One row = one human
// Email is the primary identity key
model User {
  id               String   @id @default(uuid())
  email            String   @unique
  name             String?
  avatar           String?
  
  // Multi-provider auth support
  authProviders    String   @default("email") @map("auth_providers") // Comma-separated: "email,google"
  createdWith      String   @default("email") @map("created_with") // Original signup method
  googleId         String?  @unique @map("google_id")
  emailVerified    Boolean  @default(false) @map("email_verified")
  
  // Enhanced onboarding tracking
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")
  onboardingStep      String? @map("onboarding_step") // Current step: "profile_setup", "preferences", etc.
  lastCompletedStep   String? @map("last_completed_step")
  onboardingCompletedAt DateTime? @map("onboarding_completed_at")
  
  // Legacy field for backward compatibility
  onboardingStatus String   @default("not_started") @map("onboarding_status")
  onboardingData   String?  @map("onboarding_data")
  
  // Timestamps
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  lastLoginAt      DateTime? @map("last_login_at")
  
  // Relations
  sessions         AuthSession[]
  emailTokens      EmailVerificationToken[]

  @@map("users")
}

// ============================================
// AUTH SESSIONS TABLE - Security Layer
// ============================================
// Track active sessions for validation & logout
model AuthSession {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  sessionToken String   @unique @map("session_token")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Device info (optional)
  deviceInfo   String?  @map("device_info")
  ipAddress    String?  @map("ip_address")
  
  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@map("auth_sessions")
}

// ============================================
// EMAIL VERIFICATION TOKENS TABLE
// ============================================
// Magic link verification - prevents replay attacks
model EmailVerificationToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations (optional - for tracking)
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
  @@map("email_verification_tokens")
}
